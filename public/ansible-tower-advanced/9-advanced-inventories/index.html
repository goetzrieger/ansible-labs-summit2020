<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.59.1" />
    <meta name="description" content="Ansible and Ansible Tower Labs">
<meta name="author" content="Christian, Eric, Götz, Ismail, Joachim">

    <link rel="icon" href="https://goetzrieger.github.io/images/favicon.png" type="image/png">

    <title>Advanced Inventories :: Ansible Labs for Red Hat Summit</title>

    
    <link href="https://goetzrieger.github.io/css/nucleus.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/fontawesome-all.min.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/hybrid.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/featherlight.min.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/perfect-scrollbar.min.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/auto-complete.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/atom-one-dark-reasonable.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/theme.css?1588672793" rel="stylesheet">
    <link href="https://goetzrieger.github.io/css/hugo-theme.css?1588672793" rel="stylesheet">
    
      <link href="https://goetzrieger.github.io/css/theme-red.css?1588672793" rel="stylesheet">
    

    <script src="https://goetzrieger.github.io/js/jquery-3.3.1.min.js?1588672793"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/ansible-tower-advanced/9-advanced-inventories/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://goetzrieger.github.io/">
  <img src="https://goetzrieger.github.io/images/summit-badge.png">
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="https://goetzrieger.github.io/js/lunr.min.js?1588672793"></script>
<script type="text/javascript" src="https://goetzrieger.github.io/js/auto-complete.js?1588672793"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/goetzrieger.github.io\/";
    
</script>
<script type="text/javascript" src="https://goetzrieger.github.io/js/search.js?1588672793"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/ansible-getting-started/" title="Ansible Getting Started" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/">
          Ansible Getting Started
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/ansible-getting-started/1-setup/" title="Check the Prerequisites" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/1-setup/">
          Check the Prerequisites
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-getting-started/2-adhoc/" title="Running ad hoc commands" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/2-adhoc/">
          Running ad hoc commands
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-getting-started/3-playbook/" title="Writing Your First Playbook" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/3-playbook/">
          Writing Your First Playbook
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-getting-started/4-variables/" title="Using Variables" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/4-variables/">
          Using Variables
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-getting-started/5-handlers/" title="Conditionals, Handlers and Loops" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/5-handlers/">
          Conditionals, Handlers and Loops
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-getting-started/6-templates/" title="Templates" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/6-templates/">
          Templates
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-getting-started/7-bonus/" title="Bonus Labs" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-getting-started/7-bonus/">
          Bonus Labs
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/" title="Ansible Tower Getting Started" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/">
          Ansible Tower Getting Started
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/1-intro/" title="Introduction to Tower" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/1-intro/">
          Introduction to Tower
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/2-cred/" title="Inventories, credentials and ad hoc commands" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/2-cred/">
          Inventories, credentials and ad hoc commands
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/3-projects/" title="Projects &amp; job templates" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/3-projects/">
          Projects &amp; job templates
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/4-surveys/" title="Surveys" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/4-surveys/">
          Surveys
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/5-rbac/" title="Role-based access control" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/5-rbac/">
          Role-based access control
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/6-workflows/" title="Workflows" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/6-workflows/">
          Workflows
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-getting-started/7-wrap/" title="Wrap up" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-getting-started/7-wrap/">
          Wrap up
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/ansible-tower-advanced/" title="Ansible Tower Advanced" class="dd-item 
        parent
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/">
          Ansible Tower Advanced
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/1-intro/" title="Ansible Tower Advanced" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/1-intro/">
          Ansible Tower Advanced
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/2-clustering/" title="Introduction to Ansible Tower Clustering" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/2-clustering/">
          Introduction to Ansible Tower Clustering
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/3-awx-cli-intro/" title="There is more to Tower than the Web UI" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/3-awx-cli-intro/">
          There is more to Tower than the Web UI
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/4-awx-cli-exercises/" title="Creating Tower Objects Using `awx`" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/4-awx-cli-exercises/">
          Creating Tower Objects Using `awx`
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/5-tower-cluster-jobs/" title="Run a Job in a Cluster" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/5-tower-cluster-jobs/">
          Run a Job in a Cluster
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/6-instance-groups/" title="Tower Instance Groups" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/6-instance-groups/">
          Tower Instance Groups
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/7-parallel-jobs/" title="Parallel Jobs" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/7-parallel-jobs/">
          Parallel Jobs
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/8-isolated-nodes/" title="Isolated Nodes" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/8-isolated-nodes/">
          Isolated Nodes
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/9-advanced-inventories/" title="Advanced Inventories" class="dd-item 
        parent
        active
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/9-advanced-inventories/">
          Advanced Inventories
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/10-structured-content/" title="Well Structured Content Repositories" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/10-structured-content/">
          Well Structured Content Repositories
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/11-rest-api/" title="Discovering the Tower API" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/11-rest-api/">
          Discovering the Tower API
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/ansible-tower-advanced/12-appendix/" title="Appendix" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/ansible-tower-advanced/12-appendix/">
          Appendix
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/vscode-intro/" title="Visual Studio Code Introduction" class="dd-item 
        
        
        
        ">
      <a href="https://goetzrieger.github.io/vscode-intro/">
          Visual Studio Code Introduction
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://goetzrieger.github.io/"><i class='fas fa-home'></i> Homepage</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p></p>
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://schema.org/BreadcrumbList">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='https://goetzrieger.github.io/'></a> > <a href='https://goetzrieger.github.io/ansible-tower-advanced/'>Ansible Tower Advanced</a> > Advanced Inventories
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#dynamic-inventories">Dynamic Inventories</a>
<ul>
<li><a href="#the-inventory-source">The Inventory Source</a></li>
<li><a href="#the-custom-inventory-script">The Custom Inventory Script</a></li>
<li><a href="#integrate-into-tower">Integrate into Tower</a></li>
</ul></li>
<li><a href="#what-is-the-take-away">What is the take-away?</a></li>
<li><a href="#smart-inventories">Smart Inventories</a>
<ul>
<li><a href="#a-simple-smart-inventory">A Simple Smart Inventory</a></li>
<li><a href="#build-smart-inventories-with-facts">Build Smart Inventories with Facts</a>
<ul>
<li><a href="#enable-fact-caching">Enable Fact Caching</a></li>
<li><a href="#use-facts-in-smart-inventory-searches">Use Facts in Smart Inventory Searches</a></li>
<li><a href="#nested-facts">Nested Facts</a></li>
</ul></li>
<li><a href="#challenge-lab-facts">Challenge Lab: Facts</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Advanced Inventories
            </h1>
          

        



	

<p>In Ansible and Ansible Tower, as you know, everything starts with an inventory. There are a several methods how inventories can be created, starting from simple static definitions over importing inventory files to dynamic and smart inventories.</p>

<p>In real life it’s very common to deal with external dynamic inventory sources (think cloud…). In this chapter we’ll introduce you to building dynamic inventories using custom scripts. Another great feature of Tower to deal with inventories is the Smart Inventory feature which you’ll do a lab on as well.</p>

<h2 id="dynamic-inventories">Dynamic Inventories</h2>

<p>Quite often just using static inventories will not be enough. You might be dealing with ever-changing cloud environments or you have to get your managed systems from a CMDB or other sources of truth.</p>

<p>Tower includes built-in support for syncing dynamic inventory from cloud sources such as Amazon AWS, Google Compute Engine, among others. Tower also offers the ability to use custom scripts to pull from your own inventory source.</p>

<p>In this chapter you’ll get started with dynamic inventories in Tower. Aside from the build-in sources you can write inventory scripts in any programming/scripting language that you have installed on the Tower machine. To keep it easy we’ll use a most simple custom inventory script using… Bash! Yes!</p>


<div class="notices tip" ><p>Don’t get this wrong… we’ve chosen to use Bash to make it as simple as possible to show the concepts behind dynamic and custom inventories. Usually you’d use Python or some other scripting/programming language.</p>
</div>


<h3 id="the-inventory-source">The Inventory Source</h3>

<p>First you need a source. In <strong>real life</strong> this would be your <strong>cloud provider, your CMDB or what not</strong>. For the sake of this lab we put a file into the Github repository you’ve already used to be our source</p>

<p>Use curl to query your external inventory source:</p>

<pre><code>[student@ansible ~]$ curl https://raw.githubusercontent.com/goetzrieger/ansible-labs-playbooks/master/inventory_list
{
    &quot;dyngroup&quot;:{
        &quot;hosts&quot;:[
            &quot;cloud1.cloud.example.com&quot;,
            &quot;cloud2.cloud.example.com&quot;
        ],
        &quot;vars&quot;:{
            &quot;var1&quot;: true
        }
    },
    &quot;_meta&quot;:{
        &quot;hostvars&quot;:{
            &quot;cloud1.cloud.example.com&quot;:{
                &quot;type&quot;:&quot;web&quot;
            },
            &quot;cloud2.cloud.example.com&quot;:{
                &quot;type&quot;:&quot;database&quot;
            }
        }
    }
}
</code></pre>

<p>Well, this is handy, the output is already configured as JSON like Ansible would expect… ;-)</p>


<div class="notices warning" ><p>Okay, seriously, in real life your script would likely get some information from your source system, format it as JSON and return the data to Tower.</p>
</div>


<h3 id="the-custom-inventory-script">The Custom Inventory Script</h3>

<p>An inventory script has to follow some conventions. It must accept the <strong>&ndash;list</strong> and <strong>&ndash;host &lt;hostname&gt;</strong> arguments. When it is called with <strong>&ndash;list</strong>, the script must output a JSON-encoded data containing all groups and hosts to be managed. When called with <strong>&ndash;host &lt;hostname&gt;</strong> it must return an JSON-formatted hash or dictionary of host variables (can be empty).</p>

<p>As looping over all hosts and calling the script with <strong>&ndash;host</strong> can be pretty slow, it is possible to return a top level element called &ldquo;_meta&rdquo; with all of the host variables in one script run. And this is what we’ll do. So this is our custom inventory script:</p>

<pre><code>#!/bin/bash

if [ &quot;$1&quot; == &quot;--list&quot; ] ; then
  curl https://raw.githubusercontent.com/goetzrieger/ansible-labs-playbooks/master/inventory_list
elif [ &quot;$1&quot; == &quot;--host&quot; ]; then
  echo '{&quot;_meta&quot;: {&quot;hostvars&quot;: {}}}'
else
  echo &quot;{ }&quot;
fi
</code></pre>

<p>What it basically does is to return the data collected by curl when called with <strong>&ndash;list</strong> and as the data includes <strong>_meta</strong> information about the host variables Ansible will not call it with <strong>&ndash;host</strong>. The curl command is of course the place where your script would get data by whatever means, format it as proper JSON and return it.</p>

<p>But before we integrate the custom inventory script into our Tower cluster, it’s a good idea to test it on the command line first:</p>

<ul>
<li>Bring up your VSCode terminal</li>
<li>Create the file <code>dyninv.sh</code> with the content shown above (use VI or the VSCode editor)</li>

<li><p>Make the script executable:</p>

<pre><code>[student@ansible ~]$ chmod +x dyninv.sh
</code></pre></li>

<li><p>Execute it:</p>

<pre><code>[student@ansible ~]$ ./dyninv.sh --list
{
    &quot;dyngroup&quot;:{
        &quot;hosts&quot;:[
            &quot;cloud1.cloud.example.com&quot;,
            &quot;cloud2.cloud.example.com&quot;
        ],
        &quot;vars&quot;:{
            &quot;var1&quot;: true
        }
    },
    &quot;_meta&quot;:{
        &quot;hostvars&quot;:{
            &quot;cloud1.cloud.example.com&quot;:{
                &quot;type&quot;:&quot;web&quot;
            },
            &quot;cloud2.cloud.example.com&quot;:{
                &quot;type&quot;:&quot;database&quot;
            }
        }
    }
}
</code></pre></li>
</ul>

<p>The script should output the JSON-formatted output shown above.</p>

<p>As simple as it gets, right? More information can be found <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_inventory.html">how to develop dynamic inventories</a>.</p>

<p>So now you have a source of (slightly static) dynamic inventory data (talk about oxymoron…) and a script to fetch and pass it to Tower. Now you need to get this into Tower.</p>

<h3 id="integrate-into-tower">Integrate into Tower</h3>

<p>The first step is to add the inventory script to Tower:</p>

<ul>
<li><p>In the web UI, open <strong>RESOURCES→Inventory Scripts</strong>.</p></li>

<li><p>To create a new custom inventory script, click the
<img src="../../images/green_plus.png?classes=inline" alt="plus" /> button.</p></li>

<li><p>Fill in the needed data:</p>

<ul>
<li><p><strong>NAME:</strong> Cloud Inventory Script</p></li>

<li><p>Copy the Bash script from above and paste it into the <strong>CUSTOM
SCRIPT</strong> field</p></li>
</ul></li>

<li><p>Click <strong>SAVE</strong></p></li>
</ul>

<p>Finally the new inventory script can be used in an actual <strong>Inventory</strong>.</p>

<ul>
<li><p>Go to <strong>RESOURCES→Inventories</strong></p></li>

<li><p>Click the <img src="../../images/green_plus.png?classes=inline" alt="plus" /> button and choose
<strong>Inventory</strong>.</p></li>

<li><p><strong>NAME:</strong> Cloud Inventory</p></li>

<li><p>Click <strong>SAVE</strong></p></li>

<li><p>The <strong>SOURCES</strong> button on top becomes active now, click it</p></li>

<li><p>Click the <img src="../../images/green_plus.png?classes=inline" alt="plus" /> to add a new source</p></li>

<li><p><strong>NAME:</strong> Cloud Custom Script</p></li>

<li><p>From the <strong>SOURCE</strong> drop-down choose <strong>Custom Script</strong></p></li>

<li><p>Now the dialog for the source opens, your custom script <strong>Cloud Inventory Script</strong> should already be selected in the <strong>CUSTOM INVENTORY SCRIPT</strong>.</p></li>

<li><p>Under <strong>UPDATE OPTIONS</strong> check <strong>Overwrite</strong> and <strong>Overwrite Variables</strong></p></li>

<li><p>Click <strong>SAVE</strong></p></li>
</ul>

<p>To sync your new source into the inventory:</p>

<ul>
<li><p>Open the <strong>Cloud Inventory</strong> again</p></li>

<li><p>Click the <strong>SOURCES</strong> button</p></li>

<li><p>To the right click the circular arrow to start the sync process for
your custom source.</p></li>

<li><p>After the sync has finished click the <strong>HOSTS</strong> button (the top one).</p></li>
</ul>

<p>You should now see a list of hosts according to what you got from the curl command above. Click the hosts to make sure the host variables are there, too.</p>

<h2 id="what-is-the-take-away">What is the take-away?</h2>

<p>Using this simple example you have:</p>

<ul>
<li><p>Created a script to query an inventory source</p></li>

<li><p>Integrated the script into Tower</p></li>

<li><p>Populated an inventory using the custom script</p></li>
</ul>

<h2 id="smart-inventories">Smart Inventories</h2>

<p>You will most likely have inventories from different sources in your Tower installation. Maybe you have a local CMDB, your virtualization management and your public cloud provider to query for managed systems. Imagine you now want to run automation jobs across these inventories on hosts matching certain search criteria.</p>

<p>This is where Smart Inventory comes in. A Smart Inventory is a collection of hosts defined by a stored search. Search criteria can be host attributes (like groups) or facts (such as installed software, services, hardware or whatever information Ansible pulls). A Smart Inventory can be viewed like a standard inventory and used for job runs.</p>

<p>The base rules of a search are:</p>

<ul>
<li><p>A search typically consists of a field (left-hand side) and a value     (right-hand side)</p></li>

<li><p>A colon separates the field that you want to search from the value</p></li>

<li><p>A search string without a colon is treated as a simple string</p></li>
</ul>

<h3 id="a-simple-smart-inventory">A Simple Smart Inventory</h3>

<p>Let’s start with a simple string example. In your Tower web UI, open the <strong>RESOURCES→Inventories</strong> view. Then click the <img src="../../images/green_plus.png?classes=inline" alt="plus" /> button and choose to create a new <strong>Smart Inventory</strong>. In the next view:</p>

<ul>
<li><p><strong>NAME:</strong> Smart Inventory Simple</p></li>

<li><p>Click the magnifying glass icon next to <strong>SMART HOST FILTER</strong></p></li>

<li><p>A window <strong>DYNAMIC HOSTS</strong> opens, here you define the search query</p></li>
</ul>

<p>To start with you can just use simple search terms. Try <strong>cloud</strong> or <strong>internal</strong> as search terms and see what you get after hitting <strong>ENTER</strong>.</p>


<div class="notices tip" ><p>Search terms are automatically saved so make sure to hit <strong>CLEAR ALL</strong> to clear the saved search when testing expressions.</p>
</div>


<p>Or what about searching by inventory groups? In the <strong>SEARCH</strong> field enter <strong><code>groups.name:dyngroup</code></strong>. After hitting <strong>ENTER</strong> the hosts from the dynamic inventory exercise should show up.</p>

<p>When your search returns the expected results, hit <strong>SAVE</strong> for the <strong>DYNAMIC HOSTS</strong> window and again for the Smart Inventory. Now your Smart Inventory is usable for executing job templates!</p>


<div class="notices tip" ><p>You may press the <strong>KEY</strong> button to get a feeling along which fields you can search. Browsing through the API becomes necessary to understand which related fields have which attributes (e.g. name for groups).</p>
</div>


<h3 id="build-smart-inventories-with-facts">Build Smart Inventories with Facts</h3>

<p>As you know Ansible can collect facts from managed hosts to be used in Playbooks. But before Ansible Tower 3.2 facts where only kept during a Playbook run. Ansible Tower 3.2 introduced an <strong>integrated fact cache</strong> to keep host facts for later usage and better performance. This is how we can use facts in searches for Smart Inventories.</p>

<h4 id="enable-fact-caching">Enable Fact Caching</h4>


<div class="notices warning" ><p>Fact caching is not enabled by default!</p>
</div>


<p>Fact caching can be enabled for <strong>Templates</strong> and is not enabled by default. So first we have to enable it. Check <strong>node1.internal</strong> and <strong>node2.internal</strong> have no facts stored:</p>

<ul>
<li>In <strong>RESOURCES→Inventories</strong> open the <strong>Example Inventory</strong> and click the <strong>HOSTS</strong> button.</li>

<li><p>Now inspect both hosts by opening the host details and clicking the <strong>FACTS</strong> button at the top.</p></li>

<li><p>For both hosts the <strong>FACTS</strong> field should be empty</p></li>
</ul>

<p>Now enable fact caching for the <strong>Install Apache</strong> template:</p>

<ul>
<li><p>In <strong>RESOURCES→Templates</strong> open the <strong>Install Apache</strong> template.</p></li>

<li><p>Check the <strong>ENABLE FACT CACHE</strong> tick box and click <strong>SAVE</strong></p></li>
</ul>

<p>To gather and save the facts you have to run the job template.</p>

<ul>
<li>In the <strong>Templates</strong> list start <strong>Install Apache</strong> by clicking the rocket icon</li>
</ul>

<p>Now enable fact caching for the <strong>Remote CIS Compliance</strong> template and run it, too. This way we’ll get cached facts for the remote DMZ host.</p>

<p>After you run the templates go back to the host details like you did above and check the <strong>FACTS</strong> fields for</p>

<ul>
<li><p><strong>node1.internal</strong> and <strong>node2.internal</strong> (from the <strong>Example Inventory</strong>)</p></li>

<li><p><strong>remote.internal</strong> (from the <strong>Remote Inventory</strong>).</p></li>
</ul>

<p>The hosts facts should now be populated with a lot of facts.</p>

<h4 id="use-facts-in-smart-inventory-searches">Use Facts in Smart Inventory Searches</h4>

<p>Now that we got the facts for the hosts in the facts cache, we can use facts in our searches.</p>

<ul>
<li><p>Create a new Smart Inventory named <strong>Smart Inventory Facts</strong></p></li>

<li><p>Open the <strong>SMART HOST FILTER</strong> window to enter the search</p></li>
</ul>

<p>To search for facts the search field (left side of a search query) has to start with <strong>ansible_facts.</strong> followed by the fact. The value is separated by a colon on the right side.</p>


<div class="notices warning" ><p>No blank between field and value is allowed!</p>
</div>


<p>So what could we search for… start to look at the facts of a host. As all hosts are Red Hat, searching for the fact <strong>ansible_distribution:RedHat</strong> won’t be too exciting. Ah, what the heck, just try it:</p>

<ul>
<li><p>Put <strong>ansible_facts.ansible_distribution:RedHat</strong> in the search field</p></li>

<li><p>Run the search by hitting <strong>ENTER</strong></p></li>
</ul>

<p>There should be no surprises: All hosts you have run a fact-caching enabled template on should show up.</p>

<h4 id="nested-facts">Nested Facts</h4>

<p>A small hint: If a fact is deeper in the structure like this:</p>

<pre><code>ansible_eth0:
  active: true
</code></pre>

<p>The search string would look like this:
<strong>ansible_facts.ansible_eth0.active:true</strong></p>

<h3 id="challenge-lab-facts">Challenge Lab: Facts</h3>

<p>So a small challenge: Find out if all hosts have the SElinux mode set to &ldquo;enforcing&rdquo;.</p>

<ul>
<li><p>Find the fact to use by looking at the host facts</p></li>

<li><p>Create a Smart Inventory</p></li>

<li><p>Create the proper search string</p></li>
</ul>

<p><details><summary><strong>&gt;&gt; Click here for Solution &lt;&lt;</strong></summary>
<p>
The search string to use is:
ansible_facts.ansible_selinux.mode:enforcing
It should return all hosts.
</p>
</details></p>

<p>And to make this a bit more fun:</p>

<ul>
<li><p>SSH into one of your hosts (say <strong>node2.internal</strong>) as     <code>ec2-user</code> from your VSCode terminal and set SELinux to permissive:</p>

<pre><code>[student@ansible ~]$ ssh ec2-user@node2.internal
[ec2-user@node2 ~]$ sudo -i
[root@node2 ~]# sudo setenforce 0
</code></pre></li>

<li><p>Run the <strong>Install Apache</strong> template again to update the facts.</p></li>

<li><p>Make sure the host is not showing up in the Smart inventory you just created anymore.</p></li>
</ul>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="https://goetzrieger.github.io/ansible-tower-advanced/8-isolated-nodes/" title="Isolated Nodes"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="https://goetzrieger.github.io/ansible-tower-advanced/10-structured-content/" title="Well Structured Content Repositories" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://goetzrieger.github.io/js/clipboard.min.js?1588672793"></script>
    <script src="https://goetzrieger.github.io/js/perfect-scrollbar.min.js?1588672793"></script>
    <script src="https://goetzrieger.github.io/js/perfect-scrollbar.jquery.min.js?1588672793"></script>
    <script src="https://goetzrieger.github.io/js/jquery.sticky.js?1588672793"></script>
    <script src="https://goetzrieger.github.io/js/featherlight.min.js?1588672793"></script>
    <script src="https://goetzrieger.github.io/js/highlight.pack.js?1588672793"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://goetzrieger.github.io/js/modernizr.custom-3.6.0.js?1588672793"></script>
    <script src="https://goetzrieger.github.io/js/learn.js?1588672793"></script>
    <script src="https://goetzrieger.github.io/js/hugo-learn.js?1588672793"></script>

    <link href="https://goetzrieger.github.io/mermaid/mermaid.css?1588672793" rel="stylesheet" />
    <script src="https://goetzrieger.github.io/mermaid/mermaid.js?1588672793"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>
